# Creating European Language Grid -compatible Docker images

There are two tasks to accomplish: generating and submitting metadata, and building a docker image.

## The default case

To make a ELG docker image with one language pair and two directions, run `build_elg_image_and_metadata.sh` with the language codes as arguments, optionally with regions. Eg. `build_elg_image_and_metadata.sh "fi sv-SE"`.

To specify the locations of the models you want to use, write a file called `models.txt` with one URL per line.

## Generating metadata

In principle, everything can be done by writing model URLs into `models.txt` and running `build_elg_image_and_metadata.sh`, but if defaults need to be changed, they are in a few different places.

In ELG, each language pair is one API endpoint and requires one XML metadata submission. So translating from Finnish to English *and* Finnish to English is two endpoints and two XML metadata submissions. By default, for each pair, we build one Docker image with two endpoints pointing to it.

The metadata files are automatically generated by running `generate-metadata.py`. It takes as arguments --source-lang and --target-lang, and optionally --source-region, --target-region and --version (1.0 by default). It's also in charge of writing models.txt, which is a list of locations to download models from. It only writes models.txt if it doesn't already exist.

`generate-metadata.py` has a default path for model files (`'https://object.pouta.csc.fi/OPUS-MT-models/{}-{}/opus-2019-12-04.zip'`) if you don't supply a `models.txt`, but that is obviously not ideal in the long term. Defaults for information about the project and corresponding members etc. are at the beginning of the file.

### Submitting metadata

The metadata XML is submitted via a web form at the ELG catalogue at FIXME. You have to be registered as a provider to do this.

## Prerequisites

You need to have built the main Docker image in the elg branch of Opus-MT and tagged it as opus-mt:latest.

## Building an image

Considerations for image building:

* image size and memory consumption

By default, we build one docker image per language pair, with models for both directions in the image. This will typically result in a 1.2G image currently, which can share some layers with other instances. Such a model will require more memory than the default ELG limit, which is 512MB. This is taken into account in metadata generation, but has to be increased if you make bigger images.

### Pushing the image to dockerhub

There's an organisation account called "helsinkinlp" on dockerhub. If you have the correct rights, after building you can push the image by eg. `sudo docker push helsinkinlp/opus-mt-elg-fin-eng:1.0`.
